{% extends "base.html" %}

{% block title %} 实验室物品管理 {% endblock %}
{% block content %}
<div class="container">
    <p class="lead">
        {% if request.session.is_login %}
        您好，{{ request.session.user_name }}！
        {% else %}
        您尚未登录，只能访问公开内容！
        {% endif %}
    </p>
    <div class="row text-center justify-content-md-center">
        <div class="col-lg-3 col-sm-6 section mb-3">
            <div class="card mb-3">
                <h5 class="card-title mt-3">物品</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="{% url 'inventory:items' %}" class="card-link">
                            <i class="fa fa-list-ul" aria-hidden="true"></i> 物品列表
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'inventory:add' %}" class="card-link">
                            <i class="fa fa-plus" aria-hidden="true"></i> 新建物品
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card">
                <h5 class="card-title mt-3">物品属性</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="{% url 'inventory:properties' %}" class="card-link">
                            <i class="fa fa-list-ul" aria-hidden="true"></i> 物品属性列表
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'inventory:add_property' %}" class="card-link">
                            <i class="fa fa-plus" aria-hidden="true"></i> 新建物品属性
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-lg-3 col-sm-6 section mb-3">
            <div class="card mb-3">
                <h5 class="card-title mt-3">位置</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="{% url 'inventory:location_root' %}" class="card-link">
                            <i class="fa fa-list-ul" aria-hidden="true"></i> 位置列表
                        </a>
                    </li>
                    <li class="list-group-item">
                        {% if others_request_list_count %}
                        <a href="{% url 'personal:locreq' %}" class="card-link">
                            <span class="badge badge-danger">
                                {{ others_request_list_count }}
                            </span>
                            位置申请
                        </a>
                        {% else %}
                        <a href="{% url 'personal:mylocreq' %}" class="card-link">
                            <i class="fa fa-file" aria-hidden="true"></i> 位置申请
                        </a>
                        {% endif %}
                    </li>
                </ul>
            </div>
            <div class="card">
                <h5 class="card-title mt-3">模板</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="{% url 'inventory:templates' %}" class="card-link">
                            <i class="fa fa-list-ul" aria-hidden="true"></i> 模板列表
                        </a>
                    </li>
                    {% if tmp_user.is_superadmin %}
                    <li class="list-group-item">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-plus" aria-hidden="true"></i>
                            新建模板
                        </a>
                        <div class="dropdown-menu" style="min-width: 0px;" aria-labelledby="dropdownMenuButton">
                            <a class="dropdown-item" href="{% url 'inventory:add_template' %}">物品模板</a>
                            <a class="dropdown-item" href="{% url 'inventory:add_template' %}?property=true">物品属性模板</a>
                        </div>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
        <div class="col-lg-3 col-sm-6 section mb-3">
            <div class="card">
                <h5 class="card-title mt-3">关于</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="https://github.com/zyayoung/lab-item-tracking/wiki" class="card-link">
                            <i class="fa fa-book" aria-hidden="true"></i> 使用手册
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="https://github.com/zyayoung/lab-item-tracking/issues" class="card-link">
                            <i class="fa fa-stethoscope" aria-hidden="true"></i> 反馈问题
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        {% if tmp_user.is_superadmin %}
        <div class="col-lg-3 col-sm-6 section mb-3">
            <div class="card">
                <h5 class="card-title mt-3">管理</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="{% url 'traffic:userAnalyze' %}" class="card-link">
                            <i class="fa fa-pie-chart" aria-hidden="true"></i> 图表分析
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'admin:login_user_changelist' %}" class="card-link">
                            <i class="fa fa-user" aria-hidden="true"></i> 用户管理
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'admin:index' %}" class="card-link">
                            <i class="fa fa-database" aria-hidden="true"></i> 数据管理
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="#" class="card-link" onclick="cfm()">
                            <i class="fa fa-download" aria-hidden="true"></i> 数据备份
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% if tmp_user.is_superadmin %}
<div class="modal fade" id="cfmModal" tabindex="-1" role="dialog" aria-labelledby="cfmModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cfmModalTitle">
                    <i class="fa fa-info" aria-hidden="true"></i> 提示信息
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="modalNotice"></p>
            </div>
            <div class="modal-footer" id="actions">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-outline-primary" onClick="batch_download()">确定</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
{% block script %}
{% if tmp_user.is_superadmin %}
<script>
    function cfm() {
        $('#modalNotice').html('您确认要备份数据库吗？（该过程可能需要数分钟）');
        $('#actions').html(
            '<button type="button" class="btn btn-outline-secondary" data-dismiss="modal">取消</button>\n' +
            '<button type="button" class="btn btn-outline-primary" onClick="batch_download()">确定</button>'
        );
        $('#cfmModal').modal();
    }

    function batch_download() {
        var tmp_array = [
            "{% url 'dbbackup:inventorybk' %}",
            "{% url 'dbbackup:tracebk' %}",
            "{% url 'dbbackup:usersbk' %}",
        ];

        //download
        $("iframe").remove();
        window.ids_array = tmp_array;
        download();
        $('#modalNotice').html('请耐心等待全部' + (tmp_array.length + 1) + '个文件下载完成');
        $('#actions').html('<button type="button" class="btn btn-outline-primary" data-dismiss="modal">确定</button>')
    }

    function download() {
        if (window.ids_array.length > 0) {
            $("body").append('<iframe src="' + window.ids_array.pop() + '" style="VISIBILITY: hidden"></iframe>');
            setTimeout(download, 1);
        }
    }
</script>
{% endif %}
{% endblock %}